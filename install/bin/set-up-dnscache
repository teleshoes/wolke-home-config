#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

my $DNSMASQ_CONF_FILE = '/etc/dnsmasq.conf';

sub main(@) {
  getRoot();

  runAptGet "install", "dnsmasq";
  runAptGet "remove", "resolvconf";


  my $listenAdd = "listen-address=127.0.0.1\n";

  open IN, "< $DNSMASQ_CONF_FILE" or die "Could not open $DNSMASQ_CONF_FILE for reading: $!";
  my @lines = <IN>;
  close IN;

  my $new = '';
  for(my $i=0; $i<@lines; $i++){
    my $line = $lines[$i];
    if($line =~ /^\#?listen-address=/){
      $new .= $listenAdd;
    }else{
      $new .= $line;
    }
  }

  open OUT, "> $DNSMASQ_CONF_FILE" or die "Could not open $DNSMASQ_CONF_FILE for writing: $!";
  print OUT $new;
  close OUT;

  system "sudo /etc/init.d/dnsmasq restart";
}

&main(@ARGV);
