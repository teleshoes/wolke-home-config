#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

my $GHC_VERSION = "7.6.3";
my $HP_VERSION  = "2013.2.0.0";

my $SRC_CACHE_DIR = "$ENV{HOME}/.src-cache";

sub main(@) {
  my $prefix = "$ENV{HOME}/.ghc-$GHC_VERSION";

  run "mkdir", $SRC_CACHE_DIR unless -e $SRC_CACHE_DIR;

  my $ghcinstalldir = "$SRC_CACHE_DIR/ghc-$GHC_VERSION";
  unless(-e $ghcinstalldir) {
    cd $SRC_CACHE_DIR;
    unless(-e "$ghcinstalldir.tar.bz2") {
      run "wget", "http://www.haskell.org/ghc/dist/$GHC_VERSION/ghc-$GHC_VERSION-x86_64-unknown-linux.tar.bz2";
    }
    run "tar", "-xf", "$ghcinstalldir.tar.bz2";
  }
  cd $ghcinstalldir;
  run "./configure", "--prefix=$prefix";
  run "make install";

  my $hpinstalldir = "$ENV{HOME}/.src-cache/haskell-platform-$HP_VERSION";
  unless(-e $hpinstalldir) {
    cd $SRC_CACHE_DIR;
    unless(-e "$hpinstalldir.tar.gz") {
      run "wget", "http://lambda.haskell.org/platform/download/$HP_VERSION/haskell-platform-$HP_VERSION.tar.gz";
    }
    run "tar", "-xf", "$hpinstalldir.tar.gz";
  }
  cd $hpinstalldir;
  $ENV{PATH} = "$prefix:$ENV{PATH}" unless $ENV{PATH} =~ /\Q.ghc-$GHC_VERSION\E/;
  run "./configure", "--prefix=$prefix";
  run "make";
  run "make install";

  my $config = "$ENV{HOME}/.cabal/config";
  run "mv", "$config", "$config-def" unless -e "$config-def";
  unless(-e "$config-$GHC_VERSION") {
    run "cp", "$config-def", "$config-$GHC_VERSION";
    editFile "$config-$GHC_VERSION", sub {
      my $config = shift;
      replaceLine $config, "world-file",
        "world-file: $ENV{HOME}/.cabal/world-$GHC_VERSION";
      replaceLine $config, "library-profiling",
        "library-profiling: True";
      replaceLine $config, "documentation",
        "documentation: True";
      replaceLine $config, " prefix:",
        "  prefix: $ENV{HOME}/.cabal-$GHC_VERSION";
      $config
    };
  }
}

&main(@ARGV);
