#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

sub getDefaultsSudoersConfForUser($);
sub getNoPasswdSudoersConfForUser($@);

my $SUDOERS_CONF_DIR = "/etc/sudoers.d";

sub main(@) {
  getRootSu @_;

  my $user = getUsername;

  tryrun "rm $SUDOERS_CONF_DIR/*";

  writeFile "$SUDOERS_CONF_DIR/$user", getDefaultsSudoersConfForUser($user);

  my $confDir = getInstallPath "sudo-nopasswd";
  my %confs = readConfDir $confDir;
  for my $sufix (sort keys %confs) {
    my $cnts = getNoPasswdSudoersConfForUser($user, @{$confs{$sufix}});
    writeFile "$SUDOERS_CONF_DIR/$user-$sufix", "$cnts";
  }

  run "chmod 440 /etc/sudoers.d/*";
}

sub getDefaultsSudoersConfForUser($){
  my ($user) = @_;
  join "\n"
    , "Defaults\tenv_keep += HOME"
    , "Defaults\tenv_keep += SSH_AUTH_SOCK"
    , "$user\tALL=(ALL) ALL"
    , ""
}

sub getNoPasswdSudoersConfForUser($@){
  my ($user, @conf) = @_;
  join "\n", ((map {"$user\tALL=(ALL) NOPASSWD: $_"} @conf), "")
}

&main(@ARGV);
