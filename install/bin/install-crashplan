#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

my $gpgSymCmd = getHome() . "/bin/gpg-sym";
my $secretsFile = getHome() . "/.secrets";
my $installerGlob = "/media/stuff/Images/installers/CrashPlan*.tgz";
my $libuawSrc = "/media/stuff/Images/installers/crashplan-missing-libs/libuaw.so";
my $libuawDest = "/usr/local/crashplan/nlib/libuaw.so";
my @initFiles = grep {-e $_ or -l $_} (
  glob("/etc/init.d/*crashplan*"),
  glob("/etc/rc*.d/*crashplan*"),
  glob("/etc/init.d/*code42*"),
  glob("/etc/rc*.d/*code42*"),
  glob("/etc/systemd/system/multi-user.target.wants/code42.service"),
  glob("/usr/lib/systemd/system/crashplan.service"),
  glob("/usr/lib/systemd/system/code42.service"),
);

sub main(@) {
    getRoot();
    my $installer = globOne $installerGlob;

    print "\n\nopen firefox and download and install crashplan\n";
    if(defined $installer){
      print "  maybe use this if its not too old:\n  $installer\n";
    }else{
      print "  hmm, no local file at:\n  $installerGlob\n";
    }
    print "\n\npress enter to continue\n";
    <STDIN>;

    my $contents = "";
    $contents = `cat $secretsFile` if defined $secretsFile and -f $secretsFile;
    if($contents =~ /^\s*crashplan\.secret\s*=\s*(.+)$/m and -x $gpgSymCmd){
      my $val = $1;
      my $gpgSym = procUser $gpgSymCmd, $val;
      print "crashplan:\n$gpgSym\n";
    }else{
      print "no crashplan secret found, hope its in your car\n";
    }

    print "\n\ndeleting init files\n";
    if(@initFiles > 0){
      run "rm", @initFiles;
    }else{
      print "no init files to delete\n";
    }

    print "\n\nchecking uaw installed\n";
    my $srcMd5 = md5sum($libuawSrc);
    my $destMd5 = md5sum($libuawDest);
    my $libuawBak = "$libuawDest.bak." . nowMillis();

    if(defined $srcMd5 and defined $destMd5 and $srcMd5 ne $destMd5){
      print "libuaw mismatch, backing up current to $libuawBak\n";
      run "mv", $libuawDest, $libuawBak;
    }

    if(not -e $libuawDest){
      print "copying libuaw.so (installer is stupid)\n";
      run "cp", "-ar", $libuawSrc, $libuawDest;
      run "chown", "root.root", $libuawDest;
    }else{
      print "libuaw.so is already in place\n";
    }

    print "\n\nREMEMBER TO CHANGE THE NAME OF THE FIRST BACKUP SET...\n";
}

&main(@ARGV);
