#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

my $GPG_SYM_CMD = getHome() . "/bin/gpg-sym";
my $SECRETS_FILE = getHome() . "/.secrets";
my $INSTALLER_GLOB = "/media/stuff/Images/installers/CrashPlan*.tgz";
my @INIT_FILES = grep {-e $_ or -l $_} (
  glob("/etc/init.d/*crashplan*"),
  glob("/etc/rc*.d/*crashplan*"),
  glob("/etc/init.d/*code42*"),
  glob("/etc/rc*.d/*code42*"),
  glob("/etc/systemd/system/crashplan.service"),
  glob("/etc/systemd/system/multi-user.target.wants/crashplan.service"),
  glob("/etc/systemd/system/multi-user.target.wants/code42.service"),
  glob("/usr/local/crashplan/etc/crashplan.service"),
  glob("/usr/lib/systemd/system/crashplan.service"),
  glob("/usr/lib/systemd/system/code42.service"),
);

sub main(@) {
  getRoot();
  my $installer = globOne $INSTALLER_GLOB;

  print "\n\nopen firefox and download and install crashplan\n";
  if(defined $installer){
    print "  maybe use this if its not too old:\n  $installer\n";
  }else{
    print "  hmm, no local file at:\n  $INSTALLER_GLOB\n";
  }
  print "\n\npress enter to continue\n";
  <STDIN>;

  my $contents = "";
  $contents = `cat $SECRETS_FILE` if defined $SECRETS_FILE and -f $SECRETS_FILE;
  if($contents =~ /^\s*crashplan\.secret\s*=\s*(.+)$/m and -x $GPG_SYM_CMD){
    my $val = $1;
    my $gpgSym = procUser $GPG_SYM_CMD, $val;
    print "crashplan:\n$gpgSym\n";
  }else{
    print "no crashplan secret found, hope its in your car\n";
  }

  print "\n\ndeleting init files\n";
  if(@INIT_FILES > 0){
    run "rm", @INIT_FILES;
  }else{
    print "no init files to delete\n";
  }

  run "sudo", "crashplan-fix";

  print "\n\nREMEMBER TO CHANGE THE NAME OF THE FIRST BACKUP SET...\n";
}

&main(@ARGV);
