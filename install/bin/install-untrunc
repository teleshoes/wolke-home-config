#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

my $GIT_REPO = "https://github.com/anthwlock/untrunc";

my $UNTRUNC_EXEC_DEST = "/usr/local/bin/untrunc";

my $FFMPEG_VERSION = "3.3.9";
my $FFMPEG_TAR = "/media/stuff/Images/ffmpeg/ffmpeg-$FFMPEG_VERSION.tar.xz";

sub main(@) {
  die "Usage: $0\n" if @_ > 0;

  my $dir = getSrcCache() . "/untrunc";
  if(not -d $dir){
    run "git", "clone", $GIT_REPO, $dir;
  }

  #use recommended ffmpeg version
  if(not -d "$dir/ffmpeg-$FFMPEG_VERSION"){
    run "tar",
      "-x",
      "--one-top-level=$dir",
      "-f", $FFMPEG_TAR;
  }

  run "make", "-C", $dir, "FF_VER=$FFMPEG_VERSION", "-j", "all";
  run "sudo", "rm", "-f", $UNTRUNC_EXEC_DEST;
  run "sudo", "cp", "-a", "$dir/untrunc", $UNTRUNC_EXEC_DEST;
}

&main(@ARGV);
