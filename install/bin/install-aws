#!/usr/bin/perl
use strict;
use warnings;
use lib `dirname $0 | tr -d '\n'`;
use ScriptScript;

my $PREFIX = "/usr/local";
my $IMAGE_DIR = "/media/stuff/Images/awscli";

sub main(@) {
  die "Usage: $0\n" if @_ > 0;

  my $zip = globOne "$IMAGE_DIR/awscli*.zip";
  if(not defined $zip){
    run "mkdir", "-p", $IMAGE_DIR;
    run "curl", "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip",
      "-o", "$IMAGE_DIR/awscliv2.zip";
    $zip = globOne "$IMAGE_DIR/awscli*.zip";
  }

  die "ERROR: could not retrieve zip file\n" if not defined $zip;

  my $tmpDir = "/tmp/awscli-install-" . nowMillis();
  run "mkdir", $tmpDir;
  run "unzip", "-d", $tmpDir, $zip;

  #uninstall
  run ("sudo", "rm", "-rf",
    "$PREFIX/bin/aws",
    "$PREFIX/bin/aws_completer",
    "$PREFIX/aws-cli",
  );

  run ("sudo", "$tmpDir/aws/install",
    "--bin-dir", "$PREFIX/bin",
    "--install-dir", "$PREFIX/aws-cli",
  );
  run "rm", "-rf", $tmpDir;
}

&main(@ARGV);
