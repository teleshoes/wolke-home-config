#!/usr/bin/perl
use strict;
use warnings;

my $USAGE = "Usage:
  $0 -h | --help
    show this message

  $0
";

sub nowMillis();
sub md5sum($);
sub run(@);
sub getRoot(@);

sub main(@){
  while(@_ > 0){
    my $arg = shift @_;
    if($arg =~ /^(-h|--help)$/){
      print $USAGE;
      exit 0;
    }else{
      die "$USAGE\nERROR: unknown arg $arg\n";
    }
  }
  getRoot();

}

sub nowMillis(){
  return int(time * 1000.0 + 0.5);
}

sub md5sum($){
  my ($file) = @_;
  return undef if not -f $file;
  open my $fh, "-|", "md5sum", $file
    or die "ERROR: could not run md5sum\n";
  my $out = join '', <$fh>;
  close $fh;
  if($out =~ /^([0-9a-f]{32})\s+($file)$/){
    return $1;
  }else{
    return undef;
  }
}

sub run(@){
  print "@_\n";
  system @_;
  if($? != 0){
    die "ERROR: command '@_' failed\n";
  }
}

sub getRoot(@){
  if(`whoami` ne "root\n"){
    print "rerunning as root\n";
    exec "sudo", $0, @_;
  }
}

&main(@ARGV);
