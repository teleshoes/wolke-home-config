#!/usr/bin/perl
use strict;
use warnings;
use File::Basename qw(dirname);

my $LIMIT = 10;

sub formatCurSongInfo($);
sub getCurSongInfo();
sub getSongInfo($$$);
sub ddrnameBestScore($$$);
sub getDDRStepmaniaScoreAtts($@);
sub findXmlFiles($$$);
sub readProcLine(@);

my $CURSONG_FILE = "$ENV{HOME}/.cache/stepmania-selected-song";
my $XML_UPLOAD_DIR = "$ENV{HOME}/.stepmania/Save/Upload";

my @ATTS = qw(DATETIME PASS_FAIL DDRA_SCORE PERCENT_SCORE FC_MAYBE);

sub main(@){
  print formatCurSongInfo(getCurSongInfo());
}

sub formatCurSongInfo($){
  my ($info) = @_;
  my $fmt = "$$info{songNameId}  $$info{ddrGame}   $$info{ddrDiff}\n";
  $fmt .= "BEST: $$info{ddrnameBestScore}\n";
  for my $scoreAtts(@{$$info{xmlScores}}){
    $fmt .= "$$scoreAtts{DDRA_SCORE}\n";
  }
  return $fmt;
}

sub getCurSongInfo(){
  my $out = `cat $CURSONG_FILE`;
  if($out =~ /^StepsType_(\w+)%%%Difficulty_(\w+)%%%(.+)$/){
    my ($stepsType, $difficulty, $simfile) = ($1, $2, $3);
    getSongInfo($stepsType, $difficulty, $simfile);
  }else{
    die "ERROR: could not parse $CURSONG_FILE\n";
  }
}

sub getSongInfo($$$){
  my ($stepsType, $difficulty, $simfile) = ($1, $2, $3);

  my $info = {};
  my $songDir = dirname $simfile;
  my $smGame = lc $stepsType;
  $smGame =~ s/_/-/g;
  my $smDiff = $difficulty;

  $$info{songDir}    = $songDir;
  $$info{songNameId} = readProcLine("ddr-stepmania-score", "--extract-song-name", $songDir);
  $$info{ddrGame}    = readProcLine("ddr-stepmania-score", "--extract-ddra-game", $smGame);
  $$info{ddrDiff}    = readProcLine("ddr-stepmania-score", "--extract-ddra-diff", $smDiff);

  my @xmlFiles = findXmlFiles($songDir, $smGame, $smDiff);
  @xmlFiles = reverse @xmlFiles;
  if(@xmlFiles > $LIMIT){
    @xmlFiles = @xmlFiles[0..($LIMIT-1)];
  }

  my $xmlScores = [];
  for my $xmlFile(@xmlFiles){
    my $scoreAtts = getDDRStepmaniaScoreAtts($xmlFile, @ATTS);
    push @$xmlScores, $scoreAtts;
  }

  $$info{xmlScores} = $xmlScores;

  $$info{ddrnameBestScore} = ddrnameBestScore(
    $$info{songNameId}, $$info{ddrGame}, $$info{ddrDiff});

  return $info;
}

sub ddrnameBestScore($$$){
  my ($songNameId, $ddrGame, $ddrDiff) = @_;
  return readProcLine("ddrname",
    "--scorestats",
    "--song", "$songNameId",
    "--$ddrGame",
    "--$ddrDiff",
    "--no-group-buckets",
    "--format", "%{score} (%{date})",
    "--combine-machines",
    "--best-by-bucket",
  );
}

sub getDDRStepmaniaScoreAtts($@){
  my ($xmlFile, @atts) = @_;

  my $format = join("###", map {"%$_"} @atts) . "%n";
  my $cmd = "ddr-stepmania-score --no-filename \"$xmlFile\" --format=\"$format\"";

  my $out = `$cmd`;
  chomp $out;

  my @vals = split /###/, $out;
  if(@vals == @atts - 1){
    push @vals, "";
  }
  if(@vals != @atts){
    die "ERROR: could not parse \"$cmd\" output: \"$out\"\n";
  }
  my $attVals = {};
  for(my $i=0; $i<@atts; $i++){
    $$attVals{$atts[$i]} = $vals[$i];
  }
  return $attVals;
}

sub findXmlFiles($$$){
  my ($songDir, $smGame, $smDiff) = @_;

  my $songDirRegex = $songDir;
  $songDirRegex =~ s/^\/*//;
  $songDirRegex =~ s/\/*$//;
  $songDirRegex =~ s/[^a-zA-Z0-9_\-\/]+/.*/g;
  $songDirRegex = "/*$songDirRegex/*";

  my $regex = ""
    . "<Song Dir='$songDirRegex'/>"
    . "[ \\t\\r\\n]*"
    . "<Steps Difficulty='$smDiff' StepsType='$smGame'"
    ;

  my @grepCmd = ("pcre2grep",
    "--multiline",
    "--ignore-case",
    "--files-with-matches",
    "--recursive",
    $regex,
    $XML_UPLOAD_DIR,
  );

  open CMD, "-|", @grepCmd or die "ERROR: could not run @grepCmd\n";
  my @files = <CMD>;
  close CMD;

  chomp foreach @files;
  @files = grep {$_ =~ /\.xml$/i} @files;
  return @files;
}

sub readProcLine(@){
  my @cmd = @_;
  open CMD, "-|", @cmd or die "ERROR: \"@cmd\" failed\n$!\n";
  my $out = join '', <CMD>;
  close CMD;
  chomp $out;
  return $out;
}

&main(@ARGV);
