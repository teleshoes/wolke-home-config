#!/usr/bin/perl
use strict;
use warnings;
use File::Basename qw(basename);

my $EXEC = basename $0;

my $usage = "Usage:
  use scrot-bag to take a screenshot and store it in a directory,
  not overwriting existing screenshots

  $EXEC -h | --help
    show this message

  $EXEC DIR
    -create DIR
    -cd to DIR
    -get today's date, formatted YYYYMMDD
    -find all files in DIR named: YYYYMMDD_NUM.EXT
      -EXT is png/jpg/jpeg
      -YYYYMMDD is today's date
      -NUM is a string of digits
    -find the largest NUM among these files, and add 1 to it for NEXTNUM
    -use 001 if no such files exist
    -run `scrot YYYYMMDD_NEXTNUM.png`

  $EXEC
    same as `$EXEC \$HOME`
";

sub main(@){
  if(@_ == 1 and $_[0] =~ /^(-h|--help)$/){
    print $usage;
    exit 0;
  }

  my $dir = shift || "$ENV{HOME}";
  $dir = "$ENV{PWD}/$dir" if not $dir =~ m|^/|;
  mkdir $dir;
  chdir $dir;

  my $date = `date +%Y%m%d`;
  chomp $date;

  my $maxNum = '000';
  for my $ss(`ls`){
    if($ss =~ /(?:.*\/)?  $date  _  (\d+)  \.  (png|jpg|jpeg)$/xi){
      if($1 > $maxNum){
        $maxNum = $1;
      }
    }
  }

  $maxNum++;

  my $file = "${dir}/${date}_${maxNum}.png";
  print "Taking screenshot and putting it in $file\n";
  system "scrot $file";
}

&main(@ARGV);
