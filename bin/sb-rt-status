#!/usr/bin/perl
use strict;
use warnings;
use Time::HiRes qw(time);

my $remoteHome = "/home2/teleshoes";
my $remoteDir = "$remoteHome/rt-status";

sub parseTorrents($);
sub run(@);

sub main(@){
  my $host = `seedbox --host`;
  chomp $host;

  run "ssh", $host, "
    rm -rf $remoteDir
    mkdir $remoteDir
    rtxmlrpc d.multicall main \\
      d.get_hash=             \\
      d.get_name=             \\
      d.get_directory=        \\
      d.get_completed_bytes=  \\
      d.get_size_bytes=       \\
      > $remoteDir/info
    hashes=`grep -oP \"^\\[\\'[A-F0-9]{40}\" $remoteDir/info | cut -c3-`
    echo processing \$(echo \$hashes | wc -w) torrents
    for h in \$hashes; do
      echo \"  \$h\"
      rtxmlrpc p.multicall \$h '' \\
        p.get_completed_percent=  \\
        p.get_down_rate=          \\
        p.get_down_total=         \\
        > $remoteDir/peers-\$h
    done
    echo finished
    echo
  ";

  my $localDir = "/tmp/rt-status-" . int(time*1000);

  run "mkdir", "-p", $localDir;
  run "rsync", "-avP", "$host:$remoteDir/", $localDir;

  my @torrents = parseTorrents $localDir;

  run "rm", "-rf", $localDir;
}

sub parseTorrents($){
  my $localDir = shift;
  my $infoFile = "$localDir/info";
  my $info = `cat "$infoFile"`;
  my @torrents;
  while($info =~ /
    ^\[ '([0-9A-F]{40})',\n
    ^\s '(.*)',\n
    ^\s '(.*)',\n
    ^\s (\d+),\n
    ^\s (\d+)\]\n
    /mgx){
    push @torrents, {
      hash => $1,
      name => $2,
      dir  => $3,
      completedBytes => $4,
      sizeBytes => $5,
    };
  }

  return @torrents;
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
