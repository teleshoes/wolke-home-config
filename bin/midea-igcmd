#!/usr/bin/perl
use strict;
use warnings;

my $IGCMD_REMOTE_NAME = "ac";
my $IGCMD_BTN_NAME = "custom";
my $IGCMD_BTN_FILE = "$ENV{HOME}/.config/iguana/names/$IGCMD_REMOTE_NAME/buttons/$IGCMD_BTN_NAME";

my $CONST1 = '1011';
my $CONST2 = '0010';

my $TEMPS = {
  17   => '0000',
  18   => '0001',
  19   => '0011',
  20   => '0010',
  21   => '0110',
  22   => '0111',
  23   => '0101',
  24   => '0100',
  25   => '1100',
  26   => '1101',
  27   => '1001',
  28   => '1000',
  29   => '1010',
  30   => '1011',
  same => '1111',
  off  => '1110',
};

my $FANS = {
  auto => '1011',
  low  => '1001',
  med  => '0101',
  high => '0011',
  off  => '0111',
};

my $STATES = {
  on   => '1111',
  off  => '1011',
};

my $MODES = {
  auto => '1000',
  cool => '0000',
  heat => '1100',
  fan  => '0100',
  off  => '0000',
};

sub main(@){
  my $fan = $$FANS{low};
  my $temp = $$TEMPS{t23};
  my $mode = $$MODES{cool};
  my $state = $$STATES{off};

  my $bits = "";
  $bits .= $CONST1 . $CONST2 . inv($CONST1) . inv($CONST2);
  $bits .= $fan    . $state  . inv($fan)    . inv($state);
  $bits .= $temp   . $mode   . inv($temp)   . inv($mode);

  my $ptrn = "#$bits#$bits";


  $ptrn =~ s/0/%0%/g;
  $ptrn =~ s/1/%1%/g;
  $ptrn =~ s/%0%/space 500\npulse 500\n/g;
  $ptrn =~ s/%1%/space 1500\npulse 500\n/g;
  $ptrn =~ s/#/space 5000\npulse 4400\nspace 4300\npulse 550\n/g;

  $ptrn =~ s/^space \d+\n//;

  open FH, "> $IGCMD_BTN_FILE" or die "ERROR: could not write $IGCMD_BTN_FILE\n$!\n";
  print FH $ptrn;
  close FH;
}

sub inv($){
  my ($nibble) = @_;
  $nibble =~ s/0/one/g;
  $nibble =~ s/1/zero/g;
  $nibble =~ s/zero/0/g;
  $nibble =~ s/one/1/g;
  return $nibble;
}

&main(@ARGV);
