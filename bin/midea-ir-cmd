#!/usr/bin/perl
use strict;
use warnings;

my $DEVICE_GLOB = "/dev/ttyUSB*";

my $ID1 = '1011';
my $ID2 = '0010';

my $TEMPS = {
  17   => '0000',
  18   => '0001',
  19   => '0011',
  20   => '0010',
  21   => '0110',
  22   => '0111',
  23   => '0101',
  24   => '0100',
  25   => '1100',
  26   => '1101',
  27   => '1001',
  28   => '1000',
  29   => '1010',
  30   => '1011',
  same => '1111',
  off  => '1110',
};

my $TEMP_AUX = {
  16 => [17, "c_16"],
  60 => [17, "f_60"],
  61 => [17, "f_61"],
  62 => [17, "f_lo"],
  63 => [17, "f_hi"],
  64 => [18, "f_lo"],
  65 => [18, "f_hi"],
  66 => [19, "f_lo"],
  67 => [19, "f_hi"],
  68 => [20, "f_lo"],
  69 => [20, "f_hi"],
  70 => [21, "f_lo"],
  71 => [21, "f_hi"],
 #72 => [22, "f_lo"],
  72 => [22, "f_hi"],
  73 => [23, "f_lo"],
  74 => [23, "f_hi"],
  75 => [24, "f_lo"],
  76 => [24, "f_hi"],
  77 => [25, "f_lo"],
  78 => [25, "f_hi"],
  79 => [26, "f_lo"],
  80 => [26, "f_hi"],
 #81 => [27, "f_lo"],
  81 => [27, "f_hi"],
  82 => [28, "f_lo"],
  83 => [28, "f_hi"],
  84 => [29, "f_lo"],
  85 => [29, "f_hi"],
 #86 => [30, "f_lo"],
  86 => [30, "f_hi"],
};

my $TEMP_AUX_FMT = join '',
  map {"\n        $_ = (@{$$TEMP_AUX{$_}})"}
  sort keys %$TEMP_AUX;

my $FANS = {
  auto => '1011',
  low  => '1001',
  med  => '0101',
  high => '0011',
  off  => '0111',
};

my $STATES = {
  on   => '1111',
  off  => '1011',
};

my $MODES = {
  auto => '1000',
  cool => '0000',
  dry  => '0100',
  heat => '1100',
  fan  => '0100',
  off  => '0000',
};

my $AUX_COMMANDS = {
  f_hi => '1101 0101 0110 0100 0010 0000 0000 0001 0000 0000 0101 1010',
  f_lo => '1101 0101 0010 1000 0000 0000 0000 0001 0000 0000 1111 1110',
  f_60 => '1101 0101 0110 0100 0000 0000 0001 0001 0000 0000 0100 1010',
  f_61 => '1101 0101 0110 0100 0010 0000 0001 0001 0000 0000 0110 1010',
  c_16 => '1101 0101 0110 0100 0000 0000 0001 0000 0000 0000 0100 1001',
};

my $AUX_CMD_FMT = join '',
  map {"\n        $_ = $$AUX_COMMANDS{$_}"}
  sort keys %$AUX_COMMANDS;

my $STATIC_COMMANDS = {
  eco      => '# 1011 1001 0100 0110 1111 0101 0000 1010 0110 1001 1001 0110 *',
  led      => '# 1011 1001 0100 0110 1111 0101 0000 1010 0000 1001 1111 0110 *',
};

my $STATIC_CMD_FMT = join '',
  map {"\n      $_ = $$STATIC_COMMANDS{$_}"}
  sort keys %$STATIC_COMMANDS;

my $usage = "Usage:
  $0 -h | --help
    show this message

  $0 [SERIAL_DEVICE] --reset
    -run: stty -F SERIAL_DEVICE hupcl
    -run: head -1 SERIAL_DEVICE
    -run: stty -F SERIAL_DEVICE -hupcl

  $0 [SERIAL_DEVICE] [PRESET] [STATE] [MODE] [TEMP] [FAN] [AUX_CMD]
    -generate a command string for midea-ir-arduino device
    -write command to SERIAL_DEVICE

  $0 [SERIAL_DEVICE] " . join(" | ", sort keys %$STATIC_COMMANDS) . "
    write pre-generated static command string to SERIAL_DEVICE:$STATIC_CMD_FMT

  PRESET
    on | default | normal
      same as: cool low T22
    cold
      same as: cool high T21

  STATE
    off
      set MODE to off ($$MODES{off})
      set FAN to off ($$FANS{off})
      set TEMP to off ($$TEMPS{off})

  MODE
    auto-mode | mode-auto
      set mode to auto ($$MODES{auto})
      (this is the default)
    cool
      set mode to cool ($$MODES{cool})
    dry
      set mode to dry ($$MODES{dry})
    heat
      set mode to heat ($$MODES{heat})
    fan | fan-only
      set mode to fan ($$MODES{fan})

  FAN
    auto-fan | fan-auto
      set fan to auto ($$FANS{auto})
      (this is the default)
    low
      set fan to low ($$FANS{low})
    med | medium
      set fan to med ($$FANS{med})
    high
      set fan to high ($$FANS{high})

  TEMP
    17 | 18 | 19 | 20 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 30
      set temperature in degrees celsius
    17C | 18C | 19C | 20C | 21C | 22C | 23C | 24C | 25C | 26C | 27C | 28C | 29C | 30C
      set temperature in degrees celsius
    T17 | T18 | T19 | T20 | T21 | T22 | T23 | T24 | T25 | T26 | T27 | T28 | T29 | T30
      set temperature in degrees celsius
    T17C | T18C | T19C | T20C | T21C | T22C | T23C | T24C | T25C | T26C | T27C | T28C | T29C | T30C
      set temperature in degrees celsius
    same
      set temperature to $$TEMPS{same}
      (this is the default)

  TEMP_AUX
    wrapper around TEMP and AUX_CMD to
    set fahrenheit and extra-low temps" . $TEMP_AUX_FMT . "

  AUX_CMD
    command to append to the main command" . $AUX_CMD_FMT . "

  SERIAL_DEVICE
    -g | --guess
      use the first device that matches glob: /dev/ttyUSB*
      (this is the default)
    --dev=FILE
      use FILE as SERIAL_DEVICE
    CHARACTER_SPECIAL_FILE
      any file that exists and is a character special file
";

sub guessDevice();
sub getSerialCmd($$$$$);
sub inv($);

my $ACTION_COMMAND = "command";
my $ACTION_RESET = "reset";

sub main(@){
  my $action = $ACTION_COMMAND;
  my $staticCmd = undef;
  my $auxCmd = undef;
  my $tempAux = undef;
  my $device = undef;
  my $fan = 'auto';
  my $state = 'off'; #this is ignored, apparently
  my $temp = 'same';
  my $mode = 'auto';
  while(@_ > 0){
    my $arg = shift;
    if($arg =~ /^(-h|--help)$/){
      print $usage;
      exit 0;
    }elsif($arg =~ /^(--reset)$/){
      $action = $ACTION_RESET;
    }elsif($arg =~ /^(on|default|normal)$/){
      $mode = 'cool';
      $fan = 'low';
      $temp = '22';
    }elsif($arg =~ /^(cold)$/){
      $mode = 'cool';
      $fan = 'high';
      $temp = '21';
    }elsif($arg =~ /^(off)$/){
      $mode = 'off';
      $fan = 'off';
      $temp = 'off';
    }elsif($arg =~ /^(auto-mode|mode-auto)$/){
      $mode = 'auto';
    }elsif($arg =~ /^(cool)$/){
      $mode = 'cool';
    }elsif($arg =~ /^(dry)$/){
      $mode = 'dry';
    }elsif($arg =~ /^(heat)$/){
      $mode = 'heat';
    }elsif($arg =~ /^(fan|fan-only)$/){
      $mode = 'fan';
    }elsif($arg =~ /^(auto-fan|fan-auto)$/){
      $fan = 'auto';
    }elsif($arg =~ /^(low)$/){
      $fan = 'low';
    }elsif($arg =~ /^(med|medium)$/){
      $fan = 'med';
    }elsif($arg =~ /^(high)$/){
      $fan = 'high';
    }elsif($arg =~ /^T?(17|18|19|2\d|30)C?$/){
      $temp = $1;
    }elsif(defined $$AUX_COMMANDS{$arg}){
      $auxCmd = $arg;
    }elsif(defined $$STATIC_COMMANDS{$arg}){
      $staticCmd = $arg;
    }elsif(defined $$TEMP_AUX{$arg}){
      $tempAux = $arg;
    }elsif($arg =~ /^(-g|--guess)$/){
      $device = guessDevice();
    }elsif($arg =~ /^--dev=(.+)$/){
      $device = $1;
    }elsif(-e $arg and -c $arg){
      $device = $arg;
    }else{
      die $usage;
    }
  }

  $device = guessDevice() if not defined $device;

  ($temp, $auxCmd) = @{$$TEMP_AUX{$tempAux}} if defined $tempAux;

  if($action eq $ACTION_COMMAND){
    my $cmd;
    if(defined $staticCmd){
      $cmd = $$STATIC_COMMANDS{$staticCmd};
    }else{
      $cmd = getSerialCmd(
        (defined $fan    ? $$FANS{$fan}            : undef),
        (defined $state  ? $$STATES{$state}        : undef),
        (defined $temp   ? $$TEMPS{$temp}          : undef),
        (defined $mode   ? $$MODES{$mode}          : undef),
        (defined $auxCmd ? $$AUX_COMMANDS{$auxCmd} : undef),
      );
    }

    open FH, "> $device" or die "ERROR: could not write $device\n$!\n";
    print FH $cmd;
    close FH;
  }elsif($action eq $ACTION_RESET){
    system "stty -F $device hupcl";
    system "head -1 $device";
    system "stty -F $device -hupcl";
  }else{
    die "ERROR: unknown action $action\n";
  }
}

sub guessDevice(){
  my @devices = glob $DEVICE_GLOB;
  if(@devices == 0){
    die "ERROR: could not find a device matching $DEVICE_GLOB\n";
  }
  return $devices[0];
}

sub getSerialCmd($$$$$){
  my ($fan, $state, $temp, $mode, $auxCmd) = @_;

  my $bits = "";
  $bits .= $ID1  . $ID2   . inv($ID1)  . inv($ID2);
  $bits .= $fan  . $state . inv($fan)  . inv($state);
  $bits .= $temp . $mode  . inv($temp) . inv($mode);

  $bits .= "\@$auxCmd" if defined $auxCmd;
  $bits =~ s/\s+//g;

  my $cmd = "#$bits*";

  return $cmd;
}

sub inv($){
  my ($nibble) = @_;
  $nibble =~ s/0/one/g;
  $nibble =~ s/1/zero/g;
  $nibble =~ s/zero/0/g;
  $nibble =~ s/one/1/g;
  return $nibble;
}

&main(@ARGV);
