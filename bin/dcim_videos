#!/usr/bin/perl
use strict;
use warnings;

chdir '/home/wolke/Desktop/N900/MyDocs';

sub runcmd($){
  my $cmd = shift;
  print "$cmd\n";
  system $cmd;
}

my $DCIM = 'DCIM';
my $DCIM_VIDEOS = 'DCIM_VIDEOS';
if(not -e $DCIM or not -e $DCIM_VIDEOS){
  die "could not find $DCIM or $DCIM_VIDEOS";
}

print "remove all symlinks\n";
my @files = `find $DCIM -type l -name *.mp4`;
for my $file(@files){
  chomp $file;
  $file =~ s/'/'\\''/g;
  my $cmd = "rm '$file'";
  runcmd $cmd;
}

print "move all the appropriate files to $DCIM_VIDEOS\n";
@files = `find $DCIM -type f -name *.mp4`;
for my $file(@files){
  chomp $file;
  $file =~ s/'/'\\''/g;
  if($file =~ /^DCIM\/(.*)$/){
    $file = $1;
    my $dir = $file;
    $dir =~ s/\/[^\/]*$//;
    my $cmd = "mkdir -p '$DCIM_VIDEOS/$dir'";
    runcmd $cmd;

    $cmd = "mv '$DCIM/$file' '$DCIM_VIDEOS/$dir'";
    runcmd $cmd;
  }
}

print "add new ones for all the ones in DCIM_VIDEOS\n";
@files = `find $DCIM_VIDEOS -type f -name *.mp4`;
for my $file(@files){
  chomp $file;
  $file =~ s/'/'\\''/g;
  if($file =~ /^$DCIM_VIDEOS\/(.*)$/){
    $file = $1;
    my $depth = 1;
    while($file =~ /\//g){
      $depth++;
    }
    my $cmd =
      "ln -s ".
        "'" . ("../"x$depth) . "$DCIM_VIDEOS/$file' ".
        "'$DCIM/$file'";
    runcmd $cmd;

    $cmd = "touch $DCIM/$1 --reference=$DCIM_VIDEOS/$1 --no-dereference";
    runcmd $cmd;
  }
}
