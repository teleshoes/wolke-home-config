#!/opt/pylitterbot-venv/bin/python
import asyncio
import os
import subprocess
import time
from datetime import datetime
from pathlib import Path
from pylitterbot import Account

SECRETS_FILE = str(Path.home()) + "/.secrets"

DELAY_SECONDS = 1

async def main():
  account = Account()

  username = readProc(["gpg-conf-read", SECRETS_FILE, "--key=whisker.email"])
  password = readProc(["gpg-conf-read", SECRETS_FILE, "--key=whisker.password"])

  try:
    await account.connect(username=username, password=password, load_robots=True)

    while True:
      for robot in account.robots:
        await robot.refresh()
        fmt = formatRobotInfo(robot)
        print(fmt, flush=True)
      time.sleep(DELAY_SECONDS)
  finally:
      # Disconnect from the API.
     await account.disconnect()

def formatRobotInfo(robot):
  nowFmt = datetime.now().isoformat(timespec='milliseconds')
  fmt = ",".join([ nowFmt
        , robot.name
        , robot.serial
        , "status=" + str(robot.status)
        , "litter=" + str(robot.litter_level)
        , "waste=" + str(robot.waste_drawer_level)
        ])
  return fmt

def readProc(cmd):
  return subprocess.run(cmd, stdout=subprocess.PIPE).stdout.decode('utf-8').rstrip()

if __name__ == "__main__":
  asyncio.run(main())
