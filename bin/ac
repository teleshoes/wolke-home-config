#!/usr/bin/perl
use strict;
use warnings;

my $AC_ENABLED_FILE = "$ENV{HOME}/.config/ac-enabled";

my $IPMAGIC_NAME = "raspi";

my $CMD_TOGGLE_AC = "ipmagic $IPMAGIC_NAME --sshc midea-ir-ruby-wrapper --toggle";
my $CMD_TOGGLE_FAN = "tasmota fan1";

sub isAcEnabled();
sub run(@);

my $usage = "Usage:
  $0 -h|--help
    show this message

  $0
    -check $AC_ENABLED_FILE
    -if file exists and starts with \"enabled\":
      -toggle ac 'midea_ir_ruby'
    -otherwise:
      -toggle ac 'fan1'
";

sub main(@){
  if(@_ == 1 and $_[0] =~ /^(-h|--help)$/){
    print $usage;
    exit 0;
  }elsif(@_ == 0){
    if(isAcEnabled()){
      run $CMD_TOGGLE_AC;
    }else{
      run $CMD_TOGGLE_FAN;
    }
  }else{
    die $usage;
  }
}

sub isAcEnabled(){
  my $val = `cat $AC_ENABLED_FILE 2>/dev/null`;
  if($val =~ /^\s*enabled/i){
    return 1;
  }else{
    return 0;
  }
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
