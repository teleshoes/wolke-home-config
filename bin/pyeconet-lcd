#!/usr/bin/perl
use strict;
use warnings;

my $USAGE = "Usage:
  $0 -h | --help
    show this message

  $0
    -run pyeconect --info
    -generate markup
    -send markup with pico-lcd-msg
";

sub main(@){
  while(@_ > 0){
    my $arg = shift @_;
    if($arg =~ /^(-h|--help)$/){
      print $USAGE;
      exit 0;
    }else{
      die "$USAGE\nERROR: unknown arg $arg\n";
    }
  }

  my $info = `pyeconet --info`;
  my $avail = $1 if $info =~ /^tank_hot_water_availability: (\d+)$/m;
  my $targetTemp = $1 if $info =~ /^set_point: (\d+)$/m;
  my $running = $1 if $info =~ /^running: (\w+)$/m;

  my $date = `date '+%a %b %d'`;
  chomp $date;
  my $time = `date '+%I:%M:%S %p'`;
  chomp $time;

  $time =~ s/^0/ /; #'03:05' => ' 3:05'


  my $availFmt = "";
  $availFmt .= "!size=10!";
  $availFmt .= $avail == 100 ? "!color=white!" : "!color=red!";
  $availFmt .= sprintf "%3s", $avail;
  $availFmt .= "%";

  my $tempFmt = "";
  $tempFmt .= "!size=7!";
  $tempFmt .= "!color=white!";
  $tempFmt .= sprintf "%3s", $targetTemp;
  $tempFmt .= "F";

  $tempFmt .= '!size=5!!color=green! *' if $running =~ /true/i;

  my $dateFmt = "!color=white!!size=1!!hr!!n!!size=4!!hspace=0.5!$date!n!$time";

  my $markup = "$availFmt!n!$tempFmt!n!$dateFmt";
  system "pico-lcd-msg", "--quiet", $markup;
}

&main(@ARGV);
