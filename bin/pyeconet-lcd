#!/usr/bin/perl
use strict;
use warnings;

sub main(@){
  while(1){
    my $info = `pyeconet --info`;
    my $avail = $1 if $info =~ /^tank_hot_water_availability: (\d+)$/m;
    my $targetTemp = $1 if $info =~ /^set_point: (\d+)$/m;
    my $running = $1 if $info =~ /^running: (\w+)$/m;

    my $date = `date '+%a %b %d'`;
    chomp $date;
    my $time = `date '+%r'`;
    chomp $time;


    my $availFmt = "";
    $availFmt .= "!size=10!";
    $availFmt .= $avail == 100 ? "!color=white!" : "!color=red!";
    $availFmt .= sprintf "%3s", $avail;
    $availFmt .= "%";

    my $tempFmt = "";
    $tempFmt .= "!size=7!";
    $tempFmt .= "!color=white!";
    $tempFmt .= sprintf "%3s", $targetTemp;
    $tempFmt .= "F";

    $tempFmt .= '!size=5!!color=green! *' if $running =~ /true/i;

    my $dateFmt = "!color=white!!size=2!!n!--------------------!n!!size=3!$date!n!$time";

    my $markup = "$availFmt!n!$tempFmt!n!$dateFmt";
    system "pico-lcd-msg", "--quiet", $markup;
  }
}

&main(@ARGV);
