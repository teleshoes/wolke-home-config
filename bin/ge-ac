#!/usr/bin/python3
import aiohttp
import asyncio
import logging
import sys
from configfile import (USERNAME, PASSWORD, REGION, MAC)

### suppress slimxpp warning:
###   Using slower stringprep, consider compiling the faster cython/libidn one.
from contextlib import redirect_stderr, suppress
with redirect_stderr(None), suppress(ModuleNotFoundError):
  import slixmpp
###

from gehomesdk import (
    EVENT_APPLIANCE_INITIAL_UPDATE,
    ErdAcOperationMode,
    ErdAcFanSetting,
    ErdCode,
    ErdOnOff,
    GeAppliance,
    GeWebsocketClient,
)

EVENT_LOOP = asyncio.get_event_loop()


async def handle(appliance: GeAppliance):
  if appliance.mac_addr == MAC:
    print(appliance.get_erd_value(ErdCode.AC_POWER_STATUS))
    print(appliance.get_erd_value(ErdCode.AC_OPERATION_MODE))
    print(appliance.get_erd_value(ErdCode.AC_FAN_SETTING))
    print(appliance.get_erd_value(ErdCode.AC_TARGET_TEMPERATURE))
    EVENT_LOOP.stop()

async def main():
  client = GeWebsocketClient(USERNAME, PASSWORD, REGION, EVENT_LOOP)
  client.add_event_handler(EVENT_APPLIANCE_INITIAL_UPDATE, handle)

  session = aiohttp.ClientSession()
  asyncio.ensure_future(client.async_get_credentials_and_run(session), loop=EVENT_LOOP)

if __name__ == "__main__":
  EVENT_LOOP.run_until_complete(main())
  EVENT_LOOP.run_forever()
