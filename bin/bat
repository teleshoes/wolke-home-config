#!/usr/bin/perl
use strict;
use warnings;

my $DIR = "/sys/class/power_supply/BAT0";
my @ATTS = qw(energy_now energy_full energy_full_design power_now status);

sub getBatInfo();
sub readDev($);

my $usage = "Usage:
  $0 -h | --help
    show this message

  $0
    print charge percent, charging/discharging rate in watts, and the time
";

sub main(@){
  if(@_ == 1 and $_[0] =~ /^(-h|--help)$/){
    print $usage;
    exit 0;
  }
  die $usage if @_ > 0;

  my $info = getBatInfo;

  my $powerW = $$info{power_now}/1000000.0;
  my $chargePercent = 100.0 * $$info{energy_now} / $$info{energy_full};

  my $statusFmt;
  if($$info{status} =~ /(discharg)/i){
    $statusFmt = "-";
  }elsif($$info{status} =~ /(charg)/i){
    $statusFmt = "+";
  }else{
    $statusFmt = "?";
  }

  my $time = `date +%H:%M:%S`;
  chomp $time;

  printf "\n%d%%\n%s%.1fW\n%s",
    $chargePercent,
    $statusFmt,
    $powerW,
    $time;
}

sub getBatInfo(){
  my $info = {};
  for my $att(@ATTS){
    $$info{$att} = readDev "$DIR/$att";
  }
  return $info;
}

sub readDev($){
  my ($dev) = @_;
  my $val = `cat $dev`;
  chomp $val;
  return $val;
}

&main(@ARGV);
