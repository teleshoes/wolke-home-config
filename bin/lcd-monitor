#!/usr/bin/perl
use strict;
use warnings;

my $DEVS = {
  lcd1 => [
    \&pyeconet,
  ],
};

sub main(@){
  my @btnStrs = split /,/, `pico-lcd-msg --buttons`;
  my %btnCounts;
  for my $btnStr(@btnStrs){
    $btnCounts{$1} = $2 if $btnStr =~ /^\s*(\w+)\s*=\s*(\d+)\s*$/;
  }

  my $modeCount = 0;
  $modeCount = $btnCounts{B1} if defined $btnCounts{B1};
  $modeCount = $btnCounts{Y} if defined $btnCounts{Y};

  my @modes = @{$$DEVS{lcd1}};
  my $modeIndex = $modeCount % @modes;
  my $cmd = $modes[$modeIndex];
  &$cmd();
}

sub pyeconet(){
  system "pico-lcd-msg", "--quiet", pyeconetMarkup();
}

sub pyeconetMarkup(){
  my $info = `pyeconet --info`;
  my $avail = $1 if $info =~ /^tank_hot_water_availability: (\d+)$/m;
  my $targetTemp = $1 if $info =~ /^set_point: (\d+)$/m;
  my $running = $1 if $info =~ /^running: (\w+)$/m;

  my $date = `date '+%a %b %d'`;
  chomp $date;
  my $time = `date '+%I:%M:%S %p'`;
  chomp $time;

  $time =~ s/^0/ /; #'03:05' => ' 3:05'


  my $availFmt = "";
  $availFmt .= "!size=10!";
  $availFmt .= $avail == 100 ? "!color=white!" : "!color=red!";
  $availFmt .= sprintf "%3s", $avail;
  $availFmt .= "%";

  my $tempFmt = "";
  $tempFmt .= "!size=7!";
  $tempFmt .= "!color=white!";
  $tempFmt .= sprintf "%3s", $targetTemp;
  $tempFmt .= "F";

  $tempFmt .= '!size=5!!color=green! *' if $running =~ /true/i;

  my $dateFmt = "!color=white!!size=1!!hr!!n!!size=4!!hspace=0.5!$date!n!$time";

  my $markup = "$availFmt!n!$tempFmt!n!$dateFmt";
  return $markup;
}

&main(@ARGV);
