#!/usr/bin/perl
use strict;
use warnings;
use File::Basename qw(basename);
use Time::HiRes qw(sleep);
use IPC::Open3;
use Symbol qw(gensym);

sub syncRemote($);
sub updateCache($);
sub readInfoCache($$);
sub writeInfoCache($$$);
sub formatInfoLine($$);
sub updateInfoCache($$$);
sub readMd5sumCache($$);
sub writeMd5sumCache($$$);
sub formatMd5sumLine($$);
sub updateMd5sumCache($$$$);
sub parseDuration($);
sub formatDuration($);
sub getSizes($);
sub readExcludeFile($);
sub checkExcludes($$);
sub getRsyncExcludes($);
sub md5($$);
sub fmtSize($);
sub isMountPoint($$);
sub test($@);
sub getIpmagicCmd($@);
sub getIpmagicFile($$);
sub readFile($$);
sub writeFile($$@);
sub appendFile($$@);
sub gitCmd($@);
sub printCmd(@);
sub run(@);
sub tryrunQuiet(@);
sub runQuiet(@);
sub runPrompt(@);
sub readProc($@);
sub readProcSilent($@);
sub readProcStdout($$$);

my $REMOTE_VIDEOS_DIR = "/media/videos";
my $MIRROR_VIDEOS_DIR = "/media/stuff/Videos";
my $IPMAGIC_NAME = "tv";

my @SYNC_CATEGORIES = qw(
  anime
  clips_shorts_trailers
  concerts
  courses
  movies
  operas
  series
  specials
);
my @NONSYNC_CATEGORIES = qw(
  camera
  events
);
my @ALL_CATEGORIES = sort(@SYNC_CATEGORIES, @NONSYNC_CATEGORIES);
my $OK_CATS = join "|", @ALL_CATEGORIES;

my $EXEC = basename $0;

my $USAGE = "Usage:
  $EXEC -h|--help
    show this message

  $EXEC [OPTS] --sync | --sync-remote
    perform bidirectional sync (no files copied without --no-simulate)

  $EXEC [OPTS] --cache
    perform info/md5sum updates of $REMOTE_VIDEOS_DIR only

  OPTS
    --no-git
      do not perform any git commands

    --local
      only affect the local filesystem
      fail if $REMOTE_VIDEOS_DIR is not a mountpoint

    --no-simulate
      actually copy files from and to remote
        localhost:$MIRROR_VIDEOS_DIR <=> $IPMAGIC_NAME:$REMOTE_VIDEOS_DIR
";

my $CMD_SYNC_REMOTE = "sync-remote";
my $CMD_CACHE = "cache";

sub main(@){
  my $cmd = $CMD_SYNC_REMOTE;
  my $opts = {
    useGit => 1,
    simulate => 1,
    localOnly => 0,
  };

  while(@_ > 0){
    my $arg = shift;
    if($arg =~ /^(-h|--help)$/){
      print $USAGE;
      exit 0;
    }elsif($arg =~ /^(--sync|--sync-remote)$/){
      $cmd= $CMD_SYNC_REMOTE;
    }elsif($arg =~ /^(--cache)$/){
      $cmd= $CMD_CACHE;
    }elsif($arg =~ /^(--no-simulate)$/){
      $$opts{simulate} = 0;
    }elsif($arg =~ /^(--local)$/){
      $$opts{localOnly} = 1;
    }elsif($arg =~ /^(--no-git)$/){
      $$opts{useGit} = 0;
    }else{
      die "$USAGE\nERROR: unknown arg $arg\n";
    }
  }

  die "--no-simulate and --local cannot both be given\n" if not $$opts{simulate} and $$opts{localOnly};

  if(not $$opts{localOnly}){
    die "ERROR: $MIRROR_VIDEOS_DIR does not exist\n" if not -d $MIRROR_VIDEOS_DIR;
  }

  if($cmd eq $CMD_SYNC_REMOTE){
    syncRemote($opts);
  }elsif($cmd eq $CMD_CACHE){
    updateCache($opts);
  }else{
    die "ERROR: unknown/missing cmd '$cmd'\n";
  }
}

sub syncRemote($){
  my $opts = @_;

  my $ipmagic;
  my $mainIpmagic;
  if(isMountPoint undef, $REMOTE_VIDEOS_DIR){
    $ipmagic = undef;
  }elsif(not $$opts{localOnly} and isMountPoint $IPMAGIC_NAME, $REMOTE_VIDEOS_DIR){
    $ipmagic = $IPMAGIC_NAME;
  }else{
    die "\"$REMOTE_VIDEOS_DIR\" not found locally or with \"ipmagic $IPMAGIC_NAME\"\n";
  }
  $mainIpmagic = getIpmagicFile $ipmagic, $REMOTE_VIDEOS_DIR;

  die "could not find \"main\" locally\n" if $$opts{localOnly} and defined $ipmagic;

  print "reading exclude file\n";
  my $excludes = readExcludeFile($ipmagic);
  print "\n";

  my $sizes = getSizes($ipmagic);
  print "\n";

  if(not $$opts{localOnly}){
    print "=====\n";
    print "Excluded files that are still present:\n";
    my $unexcluded = checkExcludes $excludes, $sizes;
    print map {"$_\n"} @$unexcluded;
    print "=====\n\n";

    my $rsyncExcludes = getRsyncExcludes $excludes;

    my @rsyncInfo = qw(rsync -L -a --ignore-existing --info=NAME --dry-run);

    print "=====\n";
    print "New LOCAL files: (rsync -n, no excludes, $MIRROR_VIDEOS_DIR/ => $REMOTE_VIDEOS_DIR/)\n";
    runQuiet @rsyncInfo, "$MIRROR_VIDEOS_DIR/", "$mainIpmagic/";
    print "=====\n\n";

    print "=====\n";
    print "New REMOTE files: (rsync -n, <EXCLUDES>, $REMOTE_VIDEOS_DIR/ => $MIRROR_VIDEOS_DIR/)\n";
    runQuiet @rsyncInfo, @$rsyncExcludes, "$mainIpmagic/", "$MIRROR_VIDEOS_DIR/";
    print "=====\n\n";

    my @rsyncInfoExisting = qw(rsync -a --existing --info=NAME --dry-run);

    print "=====\n";
    print "MODIFIED\n";
    runQuiet @rsyncInfoExisting, "$MIRROR_VIDEOS_DIR/", "$REMOTE_VIDEOS_DIR/";
    print "=====\n\n";

    my @rsyncReal = qw(rsync -L -avP --ignore-existing);

    if(not $$opts{simulate}){
      print "=====\n";
      print "LOCAL => REMOTE\n";
      run @rsyncReal, "$MIRROR_VIDEOS_DIR/", "$mainIpmagic/";
      print "=====\n\n";

      print "=====\n";
      print "REMOTE => LOCAL\n";
      run @rsyncReal, @$rsyncExcludes, "$mainIpmagic/", "$MIRROR_VIDEOS_DIR/";
      print "=====\n\n";
    }

    runQuiet "rsync", "-a", "$mainIpmagic/info-cache", "$MIRROR_VIDEOS_DIR/info-cache";
    runQuiet "rsync", "-a", "$mainIpmagic/md5sum-cache", "$MIRROR_VIDEOS_DIR/md5sum-cache";
    runQuiet "rsync", "-a", "$mainIpmagic/md5sum-extra", "$MIRROR_VIDEOS_DIR/md5sum-extra";
  }
}

sub updateCache($){
  my $opts = @_;

  my $ipmagic;
  my $mainIpmagic;
  if(isMountPoint undef, $REMOTE_VIDEOS_DIR){
    $ipmagic = undef;
  }elsif(not $$opts{localOnly} and isMountPoint $IPMAGIC_NAME, $REMOTE_VIDEOS_DIR){
    $ipmagic = $IPMAGIC_NAME;
  }else{
    die "\"$REMOTE_VIDEOS_DIR\" not found locally or with \"ipmagic $IPMAGIC_NAME\"\n";
  }
  $mainIpmagic = getIpmagicFile $ipmagic, $REMOTE_VIDEOS_DIR;

  die "could not find \"main\" locally\n" if $$opts{localOnly} and defined $ipmagic;

  my $sizes = getSizes($ipmagic);
  print "\n";

  print "=====\n";
  print "Info cache\n";
  updateInfoCache $ipmagic, $REMOTE_VIDEOS_DIR, "$REMOTE_VIDEOS_DIR/info-cache";
  print "=====\n\n";

  print "=====\n";
  print "Md5sum cache\n";
  updateMd5sumCache $ipmagic, $REMOTE_VIDEOS_DIR, "$REMOTE_VIDEOS_DIR/md5sum-cache", "$REMOTE_VIDEOS_DIR/md5sum-extra";
  print "=====\n\n";

  if($$opts{useGit}){
    print "=====\n";
    print "Git repo\n";
    gitCmd $ipmagic, "commit", "-a", "-m", "automatic commit";
    print "=====\n\n";
  }
}

sub readInfoCache($$){
  my ($ipmagic, $cacheFile) = @_;
  my $cache = {};
  if(test $ipmagic, "-e", $cacheFile){
    my @lines = readFile $ipmagic, $cacheFile;
    for my $line(@lines){
      next if $line =~ /^\s*$/;
      chomp $line;
      if($line =~ /^
        \s*        (\d+|\?)k
        \s* \| \s* (\d+:\d\d:\d\d\.\d\d|\?)
        \s* \| \s* (.+)
      $/x){
        my ($size, $dur, $file) = ($1, $2, $3);
        $size = undef if $size eq "?";
        $dur = parseDuration $dur;
        $$cache{$file} = [$size, $dur];
      }else{
        die "Malformed info cache line: $line\n";
      }
    }
  }
  return $cache;
}
sub writeInfoCache($$$){
  my ($ipmagic, $cacheFile, $cache) = @_;
  my @lines = map{formatInfoLine($cache, $_)} sort keys %$cache;
  writeFile $ipmagic, $cacheFile, @lines;
}
sub formatInfoLine($$){
  my ($cache, $file) = @_;
  die "missing $file\n" if not defined $$cache{$file};
  my ($size, $dur) = @{$$cache{$file}};

  my $sizeFmt = defined $size ? sprintf "%9d", $size : sprintf "%9s", "?";
  my $durFmt = formatDuration $dur;
  return "${sizeFmt}k | ${durFmt} | $file\n";
}
sub updateInfoCache($$$){
  my ($ipmagic, $dir, $cacheFile) = @_;
  my $cache = readInfoCache $ipmagic, $cacheFile;

  my @files = readProc $ipmagic, "find",
    "-L",
    $dir,
    "-not", "-path", "$dir/.git*",
    "-mindepth", "2",
    "-type", "f";
  chomp foreach @files;
  s/^$dir\/// foreach @files;

  my %okFiles = map {$_ => 1} @files;

  for my $file(sort keys %$cache){
    if(not defined $okFiles{$file}){
      delete $$cache{$file};
      print "Remove: $file\n";
      writeInfoCache $ipmagic, $cacheFile, $cache;
    }
  }

  for my $file(sort @files){
    if(not defined $$cache{$file}){
      my $size = readProc $ipmagic, "du", "-s", "$dir/$file";
      chomp $size;
      $size = $size =~ /^(\d+)\s/ ? $1 : undef;

      my $dur = readProcSilent $ipmagic, "duration", "-s", "$dir/$file";
      chomp $dur;
      $dur = $dur =~ /^(\d+\.\d+)\s/ ? $1 : undef;

      $$cache{$file} = [$size, $dur];
      print "Add: " . formatInfoLine($cache, $file);
      writeInfoCache $ipmagic, $cacheFile, $cache;
    }
  }
}

sub readMd5sumCache($$){
  my ($ipmagic, $cacheFile) = @_;
  my $cache = {};
  if(test $ipmagic, "-e", $cacheFile){
    my @lines = readFile $ipmagic, $cacheFile;
    for my $line(@lines){
      next if $line =~ /^\s*$/;
      chomp $line;
      if($line =~ /^
        \s* ([0-9a-f]{32})
        \s* \| \s* (\d+)
        \s* \| \s* (\d+)b
        \s* \| \s* (.+)
      $/x){
        my ($md5sum, $mtime, $size, $file) = ($1, $2, $3, $4);
        $$cache{$file} = {md5sum=>$md5sum, size=>$size, mtime=>$mtime};
      }else{
        die "Malformed md5sum cache line: $line\n";
      }
    }
  }
  return $cache;
}
sub writeMd5sumCache($$$){
  my ($ipmagic, $cacheFile, $cache) = @_;
  my @lines = map{formatMd5sumLine($cache, $_)} sort keys %$cache;
  writeFile $ipmagic, $cacheFile, @lines;
}
sub formatMd5sumLine($$){
  my ($cache, $file) = @_;
  my $f = $$cache{$file};
  die "missing $file\n" if not defined $f;
  return sprintf "%s|%10d|%12db|%s\n", $$f{md5sum}, $$f{mtime}, $$f{size}, $file;
}
sub updateMd5sumCache($$$$){
  my ($ipmagic, $dir, $md5sumCacheFile, $md5sumExtraFile) = @_;
  my $md5sums = readMd5sumCache $ipmagic, $md5sumCacheFile;

  print "fetching all mtimes and filesizes\n";
  my @fileStats = readProc $ipmagic, "find",
    "-L",
    $dir,
    "-not", "-path", "$dir/.git*",
    "-mindepth", "2",
    "-type", "f",
    "-exec", "stat", "-c%s-%Y-%n", "{}", ";",
    ;

  my @files;
  my %sizes;
  my %mtimes;
  for my $fileStat(@fileStats){
    if($fileStat !~ /^(\d+)-(\d+)-(.*)\n$/){
      die "invalid stat output: $fileStat";
    }
    my ($size, $mtime, $file) = ($1, $2, $3);
    $file =~ s/^$dir\///;

    push @files, $file;
    $sizes{$file} = $size;
    $mtimes{$file} = $mtime;
  }

  my %okFiles = map {$_ => 1} @files;

  my @extraMd5sums;
  for my $file(sort keys %$md5sums){
    my $info = $$md5sums{$file};
    my $isExtra = 0;
    if(not defined $okFiles{$file}){
      print "$file is not present, moving cache entry to extra\n";
      $isExtra = 1;
    }elsif($mtimes{$file} != $$info{mtime} or $sizes{$file} != $$info{size}){
      print "$file is out of date, moving cache entry to extra\n";
      $isExtra = 1;
    }

    if($isExtra){
      push @extraMd5sums, formatMd5sumLine $md5sums, $file;
      delete $$md5sums{$file};
    }
  }

  if(@extraMd5sums > 0){
    print "appending " . (0+@extraMd5sums) . " extras to $md5sumExtraFile\n";
    appendFile $ipmagic, $md5sumExtraFile, @extraMd5sums;
    writeMd5sumCache $ipmagic, $md5sumCacheFile, $md5sums;
  }

  my @missingFiles = sort grep {not defined $$md5sums{$_}} @files;

  print "missing:\n";
  print map {"$_\n"} @missingFiles;
  print "\n\n";
  print "(" . (0+@missingFiles) . " missing files)\n";

  for my $file(@missingFiles){
    print "fetching md5sum for: $file\n";
    my $md5 = md5 $ipmagic, "$dir/$file";
    $$md5sums{$file} = {md5sum=>$md5, size=>$sizes{$file}, mtime=>$mtimes{$file}};
    writeMd5sumCache $ipmagic, $md5sumCacheFile, $md5sums;
  }
}

sub parseDuration($){
  my $dur = shift;
  return undef if $dur =~ /^\s*\?\s*$/;
  if($dur !~ /^(\d+):(\d+):(\d+|\d+.\d+)$/){
    die "Malformed duration: $dur\n";
  }
  return $1*60*60 + $2*60 + $3;
}

sub formatDuration($){
  my $dur = shift;
  return sprintf "%11s", "?" if not defined $dur;

  my $h = int($dur/60/60);
  my $m = int($dur/60) - ($h*60);
  my $s = $dur - ($h*60*60) - ($m*60);
  return sprintf '%02d:%02d:%05.2f', $h, $m, $s;
}

sub getSizes($){
  my $ipmagic = shift;
  my $sizes = {};
  for my $cat(@ALL_CATEGORIES){
    print "getting sizes for: $cat\n";
    my $catSizes = {};
    my @files = readProc $ipmagic, "ls", "$REMOTE_VIDEOS_DIR/$cat";
    chomp foreach @files;
    @files = map {"$REMOTE_VIDEOS_DIR/$cat/$_"} @files;

    if(@files > 0){
      my @lines = readProc $ipmagic, "du", "-s", @files;

      for my $line(@lines){
        if($line !~ /^(\d+)\t(.*)$/){
          die "Failed du: $line\n";
        }
        my ($size, $file) = ($1, $2);
        if($file !~ /^$REMOTE_VIDEOS_DIR\/$cat\/(.+)$/){
          die "Malformed filename from du: $line\n";
        }
        my $fileName = $1;
        $$catSizes{$fileName} = $size;
      }
    }
    $$sizes{$cat} = $catSizes;
  }
  return $sizes;
}

sub readExcludeFile($){
  my $ipmagic = shift;
  my $excludeFile = "$REMOTE_VIDEOS_DIR/exclude";
  my $excludeFileIpmagic = getIpmagicFile $ipmagic, $excludeFile;
  die "Not found: $excludeFile\n" if not test $ipmagic, "-f", $excludeFile;
  my $excludes = {};
  $$excludes{$_} = {} foreach @ALL_CATEGORIES;
  my $cat;
  for my $line(readFile $ipmagic, $excludeFile){
    chomp $line;
    $line =~ s/#.*//;
    next if $line =~ /^\s*$/;
    if($line =~ /^($OK_CATS)$/){
      $cat = $line;
    }elsif($line =~ /^-/){
      $line =~ s/^-//;
      die "Missing category\n" if not defined $cat;
      die "Unknown category\n" if not defined $$excludes{$cat};
      $$excludes{$cat}{$line} = 1;
    }else{
      die "Malformed line: $line\n";
    }
  }
  return $excludes;
}

sub checkExcludes($$){
  my ($excludes, $sizes) = @_;
  my $unexcluded = [];
  for my $cat(sort keys %$excludes){
    for my $file(sort keys %{$$excludes{$cat}}){
      die "Unknown exclude: $cat/$file\n" if not defined $$sizes{$cat}{$file};
      my $mirrorFile = "$MIRROR_VIDEOS_DIR/$cat/$file";
      push @$unexcluded, $mirrorFile if test undef, "-e", $mirrorFile;
    }
  }
  return $unexcluded;
}

sub getRsyncExcludes($){
  my ($excludes) = @_;
  my $rsyncExcludes = [];
  for my $cat(sort keys %$excludes){
    for my $file(sort keys %{$$excludes{$cat}}){
      my $ex = "$cat/$file";
      $ex =~ s/\[/\\\[/g;
      $ex =~ s/\]/\\\]/g;
      push @$rsyncExcludes, "--exclude=$ex";
    }
  }
  push @$rsyncExcludes, "--exclude=.git*";
  return $rsyncExcludes;
}

sub md5($$){
  my ($ipmagic, $file) = @_;
  my $md5 = readProcSilent $ipmagic, "md5sum", $file;
  if($md5 =~ /^([0-9a-f]{32})\s*/){
    return $1;
  }else{
    die "Error finding md5sum for: $file\n";
  }
}

sub fmtSize($){
  return sprintf "%5.1fG", $_[0] / 1024 / 1024;
}

sub isMountPoint($$){
  my ($ipmagic, $dir) = @_;
  readProcSilent $ipmagic, "mountpoint", $dir;
  return $? == 0;
}

sub test($@){
  my $ipmagic = shift;
  my @test = getIpmagicCmd($ipmagic, "test", @_);
  tryrunQuiet @test;
  return $? == 0 ? 1 : 0;
}

sub getIpmagicCmd($@){
  my ($ipmagic, @cmd) = @_;
  if(defined $ipmagic){
    s/"/\\\\"/g foreach @cmd;
    s/^(.*)$/"$1"/ foreach @cmd;
    @cmd = ("ipmagic", $ipmagic, "@cmd");
  }

  if(wantarray){
    return @cmd;
  }else{
    return "@cmd";
  }
}

sub getIpmagicFile($$){
  my ($ipmagic, $file) = @_;

  if(defined $ipmagic){
    my $host = `ipmagic $ipmagic`;
    chomp $host;
    $file = "$host:$file";
  }
  return $file;
}

sub readFile($$){
  my ($ipmagic, $file) = @_;
  my @lines = readProc $ipmagic, "cat", $file;
  if(wantarray){
    return @lines;
  }else{
    return "@lines";
  }
}
sub writeFile($$@){
  my ($ipmagic, $file, @lines) = @_;
  my $tmpFile = "/tmp/video-sync-" . time . ".tmp";
  open FH, "> $tmpFile" or die "Could not write to $tmpFile ($file)\n";
  print FH @lines;
  close FH;

  runQuiet "rsync", "-aqP", $tmpFile, getIpmagicFile($ipmagic, $file);
}
sub appendFile($$@){
  my ($ipmagic, $file, @lines) = @_;
  my @prevLines = readFile $ipmagic, $file;
  writeFile $ipmagic, $file, (@prevLines, @lines);
}

sub gitCmd($@){
  my ($ipmagic, @cmd) = @_;
  tryrunQuiet getIpmagicCmd $ipmagic, "git", "-C", $REMOTE_VIDEOS_DIR, @cmd;
}

sub printCmd(@){
  my @escArgs;
  for my $arg(@_){
    my $escArg = $arg;
    if($escArg =~ /[ '"\\\$!]/){
      $escArg =~ s/'/'\\''/g;
      $escArg = "'$escArg'";
    }
    push @escArgs, $escArg;
  }
  print "@escArgs\n";
}

sub run(@){
  printCmd @_;
  runQuiet @_;
}
sub tryrunQuiet(@){
  system @_;
}
sub runQuiet(@){
  system @_;
  die "Error running @_\n" if $? != 0;
}
sub runPrompt(@){
  print "@_\nRun above [y/N]? ";
  my $ok = <STDIN>;
  if($ok eq "y\n"){
    run @_;
  }
}

sub readProc($@){
  my ($ipmagic, @cmd) = @_;
  return readProcStdout $ipmagic, \@cmd, ">&STDERR";
}
sub readProcSilent($@){
  my ($ipmagic, @cmd) = @_;
  return readProcStdout $ipmagic, \@cmd, ">/dev/null";
}
sub readProcStdout($$$){
  my ($ipmagic, $cmd, $stderr) = @_;
  my @cmdArr = getIpmagicCmd $ipmagic, @$cmd;
  my $pid = open3(gensym, \*OUT, $stderr, @cmdArr);
  my @lines = <OUT>;
  waitpid($pid, 0);
  if(wantarray){
    return @lines;
  }else{
    return join '', @lines;
  }
}

&main(@ARGV);
